<?xml version="1.0"?>
<robot name="bb_freeflyer" xmlns:xacro="http://www.ros.org/wiki/xacro">
<!-- Parameters -->
<xacro:arg name="controllers_file" default=""/>
<xacro:arg name="F_max" default="4.0"/>
<xacro:arg name="rw_tau_max" default="0.05"/>

<xacro:property name="mass" value="15.0"/> 
<xacro:property name="x" value="0.5"/>    <!-- side length -->
<xacro:property name="h" value="0.75"/>
<xacro:property name="Izz" value="${mass/12.0 * (x*x + x*x)}"/>
<xacro:property name="Ixx" value="${mass/12.0 * (x*x + h*h)}"/>
<xacro:property name="Iyy" value="${Ixx}"/>


<link name="base_link">
    <visual>
        <geometry>
            <box size="${x} ${x} 0.75"/>
        </geometry>
        <material name = "blue">
            <color rgba="0.2 0.6 0.9 1"/>
        </material>
    </visual>

    <collision>
        <geometry>
            <box size="${x} ${x} 0.75"/>
        </geometry>
    </collision>

    <inertial>
        <mass value="${mass}"/>
        <origin xyz="0 0 0"/>
        <inertia
            ixx="${Ixx}"
            iyy="${Iyy}"
            izz="${Izz}"
            ixy="0.0"
            ixz="0.0"
            iyz="0.0"/>
    </inertial>
</link>

<link name="nose_link">
    <visual>
    <geometry> 
        <box size="0.2 0.05 0.05"/> 
    </geometry> 
    <material name="red">
        <color rgba="0.9 0.2 0.2 1"/>
    </material>
</visual>
</link>

<joint name="nose_joint" type="fixed">
    <parent link="base_link"/>
    <child link="nose_link"/>
    <origin xyz="${x/2 + 0.1} 0 0"/>
</joint>

<!-- ===================== -->
<!--          IMU          -->
<!-- ===================== -->
<gazebo reference="base_link">
    <material>Gazebo/Blue</material>
    <sensor name="imu_sensor" type="imu">
        <always_on>true</always_on>
        <update_rate>100.0</update_rate>
        <visualize>false</visualize>
        <topic>/imu/data_raw</topic>
        <imu>
            <angular_velocity>
                <x>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-4</stddev>
                    </noise>
                </x>
                <y>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-4</stddev>
                    </noise>
                </y>
                <z>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-4</stddev>
                    </noise>
                </z>
            </angular_velocity>
            <linear_acceleration>
                <x>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-3</stddev>
                    </noise>
                </x>
                <y>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-3</stddev>
                    </noise>
                </y>
                <z>
                    <noise type="gaussian">
                        <mean>0.0</mean>
                        <stddev>2.0e-3</stddev>
                    </noise>
                </z>
            </linear_acceleration>
        </imu>
        <plugin name="imu_plugin" filename="libgazebo_ros_imu_sensor.so">
            <ros>
                <remapping>~/out:=/imu/data_raw</remapping>
            </ros>
            <frame_name>base_link</frame_name>
        </plugin>
    </sensor>
</gazebo>

<gazebo reference="nose_link">
    <material>Gazebo/Red</material>
</gazebo>

<!-- ===================== -->
<!-- Bang-bang thrusters  -->
<!-- ===================== -->

<gazebo>
  <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
    <parameters>$(arg controllers_file)</parameters>
  </plugin>
</gazebo>

<ros2_control name="FreeflyerSimSystem" type="system">
  <hardware>
    <plugin>freeflyer_sim_system/FreeflyerSimSystem</plugin>
    <param name="body_link">base_link</param>
    <param name="pwm_neutral">1000</param>
    <param name="pwm_max">1500</param>
    <param name="pwm_deadband">40</param>
    <param name="gamma">2.0</param>
    <param name="spool_tau">0.10</param>
    <param name="F_max">$(arg F_max)</param>
    <param name="rw_tau_max">$(arg rw_tau_max)</param>
  </hardware>

  <!-- Claimed by radial_controller (XY translation) -->
  <joint name="thruster_fwd">
    <command_interface name="command"/>
  </joint>
  <joint name="thruster_rev">
    <command_interface name="command"/>
  </joint>
  <joint name="thruster_lft">
    <command_interface name="command"/>
  </joint>
  <joint name="thruster_rgt">
    <command_interface name="command"/>
  </joint>

  <!-- Claimed by attitude_controller (reaction wheel yaw) -->
  <joint name="rw_dir">
    <command_interface name="command"/>
  </joint>
</ros2_control>


</robot>
